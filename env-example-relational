# ============================================================================
# KEYSTONE CORE API - ENVIRONMENT CONFIGURATION
# ============================================================================
# HIPAA-COMPLIANT CONFIGURATION FOR HEALTHATLAS
#
# ⚠️  SECURITY WARNINGS:
# 1. NEVER commit this file with real secrets
# 2. Use GCP Secret Manager in production for all secrets
# 3. Rotate secrets every 90 days minimum
# 4. Review access logs regularly for HIPAA audit compliance
#
# TODO: Move ALL secrets marked with <SECRET_MANAGER> to GCP Secret Manager
# ============================================================================

# ----------------------------------------------------------------------------
# APPLICATION CONFIGURATION
# ----------------------------------------------------------------------------
NODE_ENV=development  # Options: development, production, test
APP_PORT=3000
APP_NAME="Keystone Core API"
API_PREFIX=api
APP_FALLBACK_LANGUAGE=en
APP_HEADER_LANGUAGE=x-custom-lang

# HIPAA Security: Use HTTPS in production
# TODO: Enforce HTTPS at load balancer level in production
FRONTEND_DOMAIN=http://localhost:3000  # Use https:// in production
BACKEND_DOMAIN=http://localhost:3000   # Use https:// in production

# ----------------------------------------------------------------------------
# DATABASE CONFIGURATION
# ----------------------------------------------------------------------------
# HIPAA Requirement: Database must be encrypted at rest and in transit
# For GCP Cloud SQL: Use Unix sockets or SSL/TLS connections

DATABASE_TYPE=postgres
DATABASE_HOST=postgres  # In production: /cloudsql/PROJECT:REGION:INSTANCE for Cloud SQL
DATABASE_PORT=5432
DATABASE_USERNAME=root
DATABASE_PASSWORD=secret  # <SECRET_MANAGER> TODO: Move to GCP Secret Manager
DATABASE_NAME=api
DATABASE_SYNCHRONIZE=false  # NEVER true in production
DATABASE_MAX_CONNECTIONS=100
DATABASE_SSL_ENABLED=false  # MUST be true in production for HIPAA
DATABASE_REJECT_UNAUTHORIZED=false  # MUST be true in production
DATABASE_CA=  # Path to CA certificate for SSL
DATABASE_KEY=  # Path to client key for SSL
DATABASE_CERT=  # Path to client certificate for SSL
DATABASE_URL=  # Alternative: Full connection string

# ----------------------------------------------------------------------------
# FILE STORAGE
# ----------------------------------------------------------------------------
# HIPAA Requirement: Files containing PHI must be encrypted
# Recommended: Use GCP Cloud Storage with encryption at rest

FILE_DRIVER=local  # Options: local, s3, s3-presigned
ACCESS_KEY_ID=  # <SECRET_MANAGER> For S3/GCS
SECRET_ACCESS_KEY=  # <SECRET_MANAGER> For S3/GCS
AWS_S3_REGION=  # Or GCP region
AWS_DEFAULT_S3_BUCKET=  # Or GCS bucket name

# ----------------------------------------------------------------------------
# EMAIL CONFIGURATION
# ----------------------------------------------------------------------------
MAIL_HOST=maildev
MAIL_PORT=1025
MAIL_USER=
MAIL_PASSWORD=  # <SECRET_MANAGER>
MAIL_IGNORE_TLS=true
MAIL_SECURE=false
MAIL_REQUIRE_TLS=false
MAIL_DEFAULT_EMAIL=noreply@example.com
MAIL_DEFAULT_NAME=Api
MAIL_CLIENT_PORT=1080

# ----------------------------------------------------------------------------
# AUTHENTICATION - JWT SECRETS
# ----------------------------------------------------------------------------
# HIPAA CRITICAL: These secrets MUST be strong and rotated regularly
# Generate with: node -e "console.log(require('crypto').randomBytes(256).toString('base64'))"
#
# Production Requirements:
# - Use GCP Secret Manager (not environment variables)
# - Rotate every 90 days
# - Never log or expose these values
# - Access should be IAM-controlled

AUTH_JWT_SECRET=secret  # <SECRET_MANAGER> Access token signing key
AUTH_JWT_TOKEN_EXPIRES_IN=15m  # Keep short (15 minutes recommended for HIPAA)

AUTH_REFRESH_SECRET=secret_for_refresh  # <SECRET_MANAGER> Refresh token signing key
AUTH_REFRESH_TOKEN_EXPIRES_IN=3650d  # Long-lived, but rotated on use (10 years)

AUTH_FORGOT_SECRET=secret_for_forgot  # <SECRET_MANAGER> Password reset token key
AUTH_FORGOT_TOKEN_EXPIRES_IN=30m  # Short expiry for security

AUTH_CONFIRM_EMAIL_SECRET=secret_for_confirm_email  # <SECRET_MANAGER> Email confirmation key
AUTH_CONFIRM_EMAIL_TOKEN_EXPIRES_IN=1d

# ----------------------------------------------------------------------------
# TOKEN INTROSPECTION (Service-to-Service, RFC 7662)
# ----------------------------------------------------------------------------
# Service API key for introspection endpoint authentication
# HIPAA Compliance: This key must be strong and rotated every 90 days
# TODO: Move to GCP Secret Manager in production
AUTH_INTROSPECTION_SERVICE_KEY=<GCP_SECRET_MANAGER:auth-introspection-service-key>

# Rate limiting for introspection endpoint (requests per minute per service)
AUTH_INTROSPECTION_RATE_LIMIT=100

# ----------------------------------------------------------------------------
# JWT STANDARDS CONFIGURATION (RFC 7519, RFC 9068)
# ----------------------------------------------------------------------------
# Issuer URL (for iss claim in JWT tokens)
# Should match your production domain
AUTH_JWT_ISSUER=https://keystone-core-api.production.example.com

# Default audience (for aud claim in JWT tokens)
# Used for token introspection and validation
AUTH_JWT_AUDIENCE=anythingllm

# Key ID for JWT header (kid claim)
# Used for key rotation scenarios
AUTH_JWT_KEY_ID=hmac-2025-01

# Algorithm allow-list (enforce algorithm validation)
# Comma-separated list of allowed algorithms (e.g., "HS256,RS256")
# Prevents algorithm confusion attacks
AUTH_JWT_ALLOWED_ALGORITHMS=HS256

# ----------------------------------------------------------------------------
# OAUTH PROVIDERS
# ----------------------------------------------------------------------------
# HIPAA Requirement: NEVER request health-related OAuth scopes
# Only use for identity authentication, not PHI access
#
# Facebook OAuth (Optional)
FACEBOOK_APP_ID=
FACEBOOK_APP_SECRET=  # <SECRET_MANAGER>

# Google OAuth (Required for Google Sign-In)
# Get credentials: https://console.cloud.google.com/apis/credentials
GOOGLE_CLIENT_ID=1026642493663-j8r55mehd9mp6fcgkjl4hj8lsr4hl64g.apps.googleusercontent.com
  # Public, can be in code
GOOGLE_CLIENT_SECRET=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  # <SECRET_MANAGER> MUST be in Secret Manager

# Apple Sign In (Required for Sign in with Apple)
# Format: JSON array of allowed bundle IDs
# Example: ["com.healthatlas.app", "com.healthatlas.web"]
APPLE_APP_AUDIENCE=["com.healthatlas.app", "com.healthatlas.auth"]

# Apple Server-to-Server Notification Endpoint (Optional but Recommended)
# Configure in Apple Developer Console under your App ID
# Endpoint URL: https://your-domain.com/api/v1/auth/apple/notifications
# Requirements:
#   - Must be HTTPS with TLS 1.2 or higher
#   - Must be publicly accessible (Apple POSTs to this)
#   - Must return 200 OK to acknowledge receipt
# Events received:
#   - email-disabled: User stopped using Hide My Email
#   - email-enabled: User started using Hide My Email
#   - consent-revoked: User stopped using Sign in with Apple (sessions invalidated)
#   - account-delete: User deleted Apple account (account soft-deleted)
# HIPAA Compliance: All events logged for audit trail, no PHI processed

# ----------------------------------------------------------------------------
# RATE LIMITING (HIPAA Security)
# ----------------------------------------------------------------------------
# Protection against brute force attacks and abuse
# Adjust based on legitimate traffic patterns
#
# Global rate limits (applies to most endpoints)
THROTTLE_TTL=60000  # Time window in milliseconds (60 seconds)
THROTTLE_LIMIT=10   # Max requests per TTL per IP

# Auth endpoint rate limits (stricter for security)
THROTTLE_AUTH_TTL=60000  # Time window in milliseconds (60 seconds)
THROTTLE_AUTH_LIMIT=5    # Max login/register attempts per TTL per IP

# Production TODO: Use Redis for distributed rate limiting across instances
# THROTTLE_STORAGE=redis
# THROTTLE_REDIS_URL=redis://redis:6379/1

# ----------------------------------------------------------------------------
# SESSION MANAGEMENT (HIPAA Compliance)
# ----------------------------------------------------------------------------
# Sessions are used for refresh token rotation and audit trails
#
# TODO: Implement these environment variables in session cleanup service
SESSION_RETENTION_DAYS=90  # How long to keep inactive sessions
SESSION_CLEANUP_ENABLED=true  # Enable automated cleanup job
SESSION_CLEANUP_CRON="0 2 * * *"  # Daily at 2 AM UTC

# ----------------------------------------------------------------------------
# AUDIT LOGGING (HIPAA REQUIRED)
# ----------------------------------------------------------------------------
# HIPAA Requirement: Audit logs must be retained for 6+ years
# All authentication events are logged with timestamps, user IDs, and outcomes
#
# TODO: Configure GCP Cloud Logging
# GCP_PROJECT_ID=your-project-id
# GCP_LOG_NAME=auth-audit
# GCP_LOG_RETENTION_DAYS=2555  # 7 years for HIPAA compliance

# Log level for application (not audit logs)
LOG_LEVEL=info  # Options: error, warn, info, debug, verbose

# ----------------------------------------------------------------------------
# GCP INTEGRATION (PRODUCTION)
# ----------------------------------------------------------------------------
# TODO: Configure these for production deployment
#
# GCP_PROJECT_ID=your-project-id
# GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account-key.json
# GCP_REGION=us-central1
# GCP_CLOUD_RUN_SERVICE=keystone-core-api

# ----------------------------------------------------------------------------
# DOCUMENT PROCESSING (HIPAA-Compliant OCR with GCP Document AI)
# ----------------------------------------------------------------------------
# Documents contain PHI - full HIPAA controls required
# ALL sensitive values MUST be in GCP Secret Manager in production

# GCP Project Configuration
DOC_PROCESSING_GCP_PROJECT_ID=your-gcp-project-id
DOC_PROCESSING_GCP_LOCATION=us  # Options: us, eu, asia-northeast1

# GCP Document AI
DOC_PROCESSING_PROCESSOR_ID=your-processor-id
# ^ Get from: https://console.cloud.google.com/ai/document-ai/processors
# ^ Recommended: Enterprise Document OCR for medical documents
# ^ Ensure processor is HIPAA-eligible (requires BAA with Google)

DOC_PROCESSING_OUTPUT_BUCKET=healthatlas-docai-output-prod
# ^ Bucket for batch processing outputs (separate from main storage)

# GCP Cloud Storage
DOC_PROCESSING_STORAGE_BUCKET=healthatlas-documents-prod
# ^ Main bucket for raw uploads and processed files
# ^ TODO: Configure with:
# ^   - Server-side encryption (Google-managed keys or CMEK)
# ^   - Uniform Bucket-Level Access (UBLA)
# ^   - Lifecycle policy: delete after 8 years
# ^   - Audit logging enabled (Data Access logs)
# ^   - Regional location (no multi-region for PHI)

DOC_PROCESSING_RAW_PREFIX=raw/
DOC_PROCESSING_PROCESSED_PREFIX=processed/

# Processing Configuration
DOC_PROCESSING_MAX_FILE_SIZE_MB=10  # Maximum upload size
DOC_PROCESSING_RETENTION_YEARS=8    # HIPAA: Minimum 6 years, using 8 for safety
DOC_PROCESSING_SYNC_MAX_PAGES=15    # Documents with ≤15 pages use synchronous processing

# ----------------------------------------------------------------------------
# DOCUMENT PROCESSING - HIPAA COMPLIANCE CHECKLIST
# ----------------------------------------------------------------------------
# ⚠️  CRITICAL: Before using in production:
#
# 1. ✅ Sign Business Associate Agreement (BAA) with Google Cloud
#      https://cloud.google.com/terms/hipaa-baa
#
# 2. ✅ Enable audit logging on:
#      - Document AI API
#      - Cloud Storage buckets (Data Access logs)
#
# 3. ✅ Configure IAM roles (least privilege):
#      - roles/documentai.apiUser (for service account)
#      - roles/storage.objectCreator (for uploads)
#      - roles/storage.objectViewer (for downloads)
#
# 4. ✅ Set up bucket lifecycle policies:
#      gsutil lifecycle set lifecycle.json gs://BUCKET_NAME
#      (Delete objects after 8 years)
#
# 5. ✅ Enable server-side encryption:
#      - Google-managed keys (default) OR
#      - Customer-managed encryption keys (CMEK) for higher security
#
# 6. ✅ Configure Uniform Bucket-Level Access (UBLA):
#      gsutil uniformbucketlevelaccess set on gs://BUCKET_NAME
#
# 7. ✅ Move all secrets to GCP Secret Manager:
#      - DOC_PROCESSING_GCP_PROJECT_ID (can stay in env)
#      - Service account key JSON (never in env vars)
#
# 8. ✅ Configure alerting for:
#      - Processing failures
#      - Unauthorized access attempts
#      - Hard delete job failures
#
# 9. ✅ Review and approve data processing addendum (DPA)
#
# 10. ✅ Enable VPC Service Controls (optional, high security)
#
# See: docs/document-processing-hipaa-checklist.md for full checklist
# ----------------------------------------------------------------------------

# ----------------------------------------------------------------------------
# WORKER / BACKGROUND JOBS
# ----------------------------------------------------------------------------
WORKER_HOST=redis://redis:6379/1

# ----------------------------------------------------------------------------
# MONITORING & ALERTING (HIPAA RECOMMENDED)
# ----------------------------------------------------------------------------
# TODO: Configure monitoring for production
#
# SENTRY_DSN=  # Error tracking
# DATADOG_API_KEY=  # Metrics and APM
# PAGERDUTY_API_KEY=  # Incident management

# ============================================================================
# PRODUCTION CHECKLIST
# ============================================================================
#
# Before deploying to production, ensure:
#
# 1. ✅ All <SECRET_MANAGER> values moved to GCP Secret Manager
# 2. ✅ NODE_ENV=production
# 3. ✅ DATABASE_SSL_ENABLED=true
# 4. ✅ FRONTEND_DOMAIN and BACKEND_DOMAIN use HTTPS
# 5. ✅ Strong, random secrets for all AUTH_*_SECRET values
# 6. ✅ Rate limiting configured appropriately for your traffic
# 7. ✅ GCP Cloud Logging configured with 7-year retention
# 8. ✅ Monitoring and alerting configured
# 9. ✅ Backup and disaster recovery plan in place
# 10. ✅ Security audit and penetration testing completed
# 11. ✅ HIPAA compliance review with legal team
# 12. ✅ Business Associate Agreements (BAAs) signed with all vendors
#
# ============================================================================
